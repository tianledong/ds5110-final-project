---
title: "DS 5110 Final Project"
author: "Tim Cauley"
date: '2022-03-16'
output: pdf_document
header-includes:
  \usepackage{fvextra}
  \DefineVerbatimEnvironment{Highlighting}{Verbatim}{breaklines,commandchars=\\\{\}}
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	echo = TRUE,
	message = FALSE,
	warning = FALSE
)
```

# First Steps (Importing, cleaning, eda, joining)
## Importing packages

```{r message=FALSE, warning=FALSE}
library(dplyr)
library(readr)
library(ggplot2)
library(modelr)
library(tidyr)
library(grid)
library(gridExtra)
```

## Importing Data

```{r message=FALSE, warning=FALSE}
sat <- read_csv("/Users/Tim/Downloads/sat_performance.csv")
expend <- read_csv("/Users/Tim/Downloads/PerPupilExpenditures.csv")
salary <- read_csv("/Users/Tim/Downloads/TeacherSalaries.csv")
enroll <- read_csv("/Users/Tim/Downloads/enrollmentbygrade.csv")
ap <- read_csv("/Users/Tim/Downloads/ap_participation.csv")
reten <- read_csv("/Users/Tim/Downloads/staffingretention.csv")
classSize <- read_csv("/Users/Tim/Downloads/ClassSizebyRaceEthnicity.csv")
college <- read_csv("/Users/Tim/Downloads/Gradsattendingcollege.csv")
attendance <- read_csv("/Users/Tim/Downloads/attendance.csv")
attrition <- read_csv("/Users/Tim/Downloads/AttritionReport.csv")
advCourse <- read_csv("/Users/Tim/Downloads/AdvancedCourseCompletion.csv")
gradRate <- read_csv("/Users/Tim/Downloads/gradrates.csv")
art <- read_csv("/Users/Tim/Downloads/artcourse.csv")
eduAge <- read_csv("/Users/Tim/Downloads/EducatorsbyAgeGroupsReport.csv")
discipline <- read_csv("/Users/Tim/Downloads/StudentDisciplineDataReport.csv")
eduGen <- read_csv("/Users/Tim/Downloads/staffracegender.csv")
teachData <- read_csv("/Users/Tim/Downloads/teacherdata.csv")
pop <- read_csv("/Users/Tim/Downloads/finalProject/ClassSizebyGenPopulation.csv")
eth <- read_csv("/Users/Tim/Downloads/finalProject/ClassSizebyRaceEthnicity.csv")
dropout <- read_csv("/Users/Tim/Downloads/finalProject/dropout.csv")
mobile <- read_csv("/Users/Tim/Downloads/finalProject/mobilityrates.csv")
teachProg <- read_csv("/Users/Tim/Downloads/Teacherprogramarea.csv")
daysMissed <- read_csv("/Users/Tim/Downloads/ssdr_days_missed.csv")
selectPop <- read_csv("/Users/Tim/Downloads/selectedpopulations.csv")

```

## EDA

### 1. Teacher Salary vs. Graduation Rate
```{r echo=FALSE}
gradRate_teacherSalary <- left_join(gradRate, salary, by="District Code") 
gradRate_teacherSalary$`Average Salary` <- parse_number(gradRate_teacherSalary$`Average Salary`)

gradRate_teacherSalary_graph <-
  ggplot(gradRate_teacherSalary, aes(x = `Average Salary`, 
                                 y = `% Graduated` )) + geom_point() + 
  theme_minimal() + 
  ggtitle("Graduate rate percentage vs. 
          Average teacher salary") + geom_smooth(method=lm) + ylim(50,100)

gradRate_teacherSalary_graph
```

### 2. Teacher Data vs. Graduation Rate
```{r echo=FALSE}
gradRate_teacherData <- left_join(gradRate, teachData, by="District Code")

gradRate_teacherData$`Student / Teacher Ratio` <- substr(gradRate_teacherData$`Student / Teacher Ratio`,1,nchar(gradRate_teacherData$`Student / Teacher Ratio`)-5) %>% parse_number()

gradRate_teacherData_graph <-
  ggplot(gradRate_teacherData, aes(x = `Percent of Experienced Teachers`, 
                                 y = `% Graduated` )) + geom_point() + 
  theme_minimal() + 
  ggtitle("Graduate rate percentage vs. 
          Experienced teacher percentage") + geom_smooth(method=lm) + 
  ylim(75, 100)

gradRate_teacherData_graph

StudentTeacherRatio_graph <-
  ggplot(gradRate_teacherData, aes(x = `Student / Teacher Ratio`, 
                                 y = `% Graduated` )) + geom_point() + 
  theme_minimal() + 
  ggtitle("Graduate rate percentage vs. 
          Student teacher ratio") + geom_smooth(method=lm) 

StudentTeacherRatio_graph

```
Observation: there may be a correlation; the more experienced teacher, the higher graduation rate. 
Observation: there may be a correlation; the higher student/teacher ratio, the lower graduation rate. 

### 3. Student Discipline vs. Graduation Rate
```{r echo=FALSE}


gradRate_discipline <- left_join(gradRate, discipline, by="District Code") %>% na.omit()



gradRate_discipline_graph <-
  ggplot(gradRate_discipline, aes(x = `% In-School Suspension`, 
                                 y = `% Graduated` )) + geom_point() + 
  theme_minimal() + 
  ggtitle("Graduate rate percentage vs. 
          Student discipline") + geom_smooth(method=lm) 

gradRate_discipline_graph
```


### 4. Demographic vs. Graduation Rate
```{r echo=FALSE}


gradRate_demographic <- left_join(gradRate, eduGen, by=c("District Code" = "District/School Code")) %>% na.omit()

gradRate_demographic_long <- pivot_longer(gradRate_demographic, cols=11:17, 
                                          names_to = "Race", 
                                          values_to = "Number of Students")

print(gradRate_demographic_long)

gradRate_demographic_graph <-
  ggplot(gradRate_demographic_long, aes(x = `Number of Students`, 
                                 y = `% Graduated`, color = Race)) + 
  geom_point() + 
  theme_minimal() + 
  ggtitle("Graduate rate percentage vs. 
          Staff Demographic") + xlim(0, 1000)+ facet_grid(Race ~.) + 
  geom_smooth(method=lm) 

gradRate_demographic_graph 
```


### 5. Staffing Retention vs. Graduation Rate

```{r echo=FALSE}

gradRate_staffingRetention <- left_join(gradRate, reten, 
                                        by="District Code") %>% na.omit()

gradRate_staffingRetention_graph <-
  ggplot(gradRate_staffingRetention, aes(x = `Teacher % Retained`, 
                                 y = `% Graduated` )) + geom_point() + 
  theme_minimal() + 
  ggtitle("Graduate rate percentage vs. 
          Teacher Retention") + geom_smooth(method=lm) 

gradRate_staffingRetention_graph
```

### 6. Graduation Rate vs. Day missed

```{r echo=FALSE}

gradRate_daysMissed <- left_join(gradRate, daysMissed, by="District Code") %>% 
  select(!...10) %>% na.omit()

gradRate_daysMissed_long <- pivot_longer(gradRate_daysMissed, cols=13:17, 
                                         names_to = "Number of Days Missed", 
                                         values_to = "Percent")

gradRate_daysMissed_graph <-
  ggplot(gradRate_daysMissed_long, aes(x = Percent, 
                                 y = `% Graduated`, 
                                 color = `Number of Days Missed`)) + geom_point() + 
  theme_minimal() + 
  ggtitle("Graduate rate percentage vs. 
          Number of Days missed percentage") + facet_grid(`Number of Days Missed` ~.) + geom_smooth(method=lm)
gradRate_daysMissed_graph 

```

### 7. SAT vs. Graduation Rate

```{r echo=FALSE}

gradRate_SAT <- left_join(gradRate, sat, by="District Code") 

gradRate_SAT_long <- pivot_longer(gradRate_SAT, cols=12:14, 
                                  names_to = "SAT test types", 
                                  values_to = "SAT test scores")

gradRate_SAT_long <- gradRate_SAT_long[!(is.na(gradRate_SAT_long$`SAT test scores`)), ]


gradRate_SAT_graph <-
  ggplot(gradRate_SAT_long, aes(x = `SAT test scores`, 
                                 y = `% Graduated`, 
                                color = `SAT test types`)) + geom_point() + 
  theme_minimal() + 
  ggtitle("Graduate rate percentage vs. 
          SAT") + geom_smooth(method=lm) + ylim(60,100)
gradRate_SAT_graph 
```

### 9. Graduation rate vs. Students Background

```{r echo=FALSE}
gradRate_selectPop <- gradRate
gradRate_selectPop$`District Code` <- as.numeric(gradRate_selectPop$`District Code`)
gradRate_selectPop <- left_join(gradRate_selectPop, pop, by="District Code")

gradRate_selectPop_graph <-
  ggplot(gradRate_selectPop, aes(x = `Economically Disadvantaged %`, 
                                 y = `% Graduated`)) + geom_point() + 
  theme_minimal() + 
  ggtitle("Graduate rate percentage vs. 
          Economically Disadvantaged % Students") +
  geom_smooth(method=lm)
gradRate_selectPop_graph 
```


```{r echo=FALSE}
gradRate_mobilityRate <- gradRate
gradRate_mobilityRate$`District Code` <- as.numeric(gradRate_mobilityRate$`District Code`)
gradRate_mobilityRate <- left_join(gradRate_mobilityRate, mobile, by="District Code")

gradRate_mobilityRate_long <- pivot_longer(gradRate_mobilityRate, cols=12:13, 
                                           names_to = "churn_intake", 
                                          values_to = "Percent")

gradRate_mobility_graph <-
  ggplot(gradRate_mobilityRate_long, aes(x = Percent, 
                                 y = `% Graduated`, 
                                 color = churn_intake)) + geom_point() + 
  theme_minimal() + 
  ggtitle("Graduate rate percentage vs. 
          Mobility rate") + facet_grid(churn_intake ~.) + xlim(0, 15) + 
  ylim(50, 100) +  geom_smooth(method=lm) 
gradRate_mobility_graph 
```




## Cleaning data for joining

```{r}
sat <- sat %>% mutate(`Total Score` = `Reading / Writing` + Math) %>% 
  select(!Writing)
expend <- expend %>% select(`District Code`, `Total Expenditures per Pupil`)
expend$`Total Expenditures per Pupil` <- parse_number(expend$`Total Expenditures per Pupil`)
enroll <- enroll %>% 
  mutate(`HS Enrollment` = `9` + `10` + `11` + `12`) %>% 
  select(`District Code`, `HS Enrollment`, Total) %>% 
  rename(Enrollment = Total)
ap <- ap %>% select(`District Code`, `Tests Takers`)
reten <- reten %>% select(`District Code`, `Teacher % Retained`) %>% 
  rename(`Teacher Retention Rate` = `Teacher % Retained`)
salary <- salary %>% select(!`District Name`)
salary$`Average Salary` <- parse_number(salary$`Average Salary`)
salary$`Salary Totals` <- parse_number(salary$`Salary Totals`)
classSize <- classSize %>% select(`District Code`, `Average Class Size`)
college <- college %>% 
  select(`District Code`, `Attending Coll./Univ. (%)`)
attendance <- attendance %>% select(`District Code`, `Attendance Rate`, `Average # of Absences`)
attrition <- attrition %>% select(`District Code`, ALL) %>% 
  rename(Attrition = ALL)
advCourse <- advCourse %>% 
  select(`District Code`, `% Students Completing Advanced`, `% Math`, `% ELA`) %>% 
  rename(`Adv Course % Math` = `% Math`, `Adv Course % ELA` = `% ELA`)
gradRate <- gradRate %>% select(`District Code`, `% Graduated`)
art <- art %>% 
  mutate(`% in an Art Course` = `All Grades` / `Total Students` * 100) %>% 
  select(`District Code`, `% in an Art Course`)
eduAge <- eduAge %>% 
  mutate(`% of Teachers <40` = (`<26 yrs (# )` + `26-32 yrs (#)` + `33-40 yrs (#)`) / `FTE Count` * 100) %>% 
  select(`District Code`, `% of Teachers <40`)
discipline <- discipline %>% 
  mutate(`% Disciplined` = `Students Disciplined` / `Students` * 100) %>% 
  select(`District Code`, `% Disciplined`)
eduGen <- eduGen %>% 
  mutate(`% Female Teachers` = `Females (#)` / `FTE Count` * 100) %>% 
  select(`District/School Code`, `% Female Teachers`) %>% 
  rename(`District Code` = `District/School Code`)
teachData <- teachData %>% select(!`District Name`)
teachData$`Student / Teacher Ratio` <- substr(teachData$`Student / Teacher Ratio`,1,nchar(teachData$`Student / Teacher Ratio`)-5) %>% parse_number()

pop <- pop %>% select(`District Code`, `English Language Learner %`, `Students with Disabilities %`, `Economically Disadvantaged %` )

eth <- eth %>% select(-`District Name`, -`Total # of Classes`, -`Average Class Size`, -`Number of Students`)

dropout <- dropout %>% select(`District Code`, `% Dropout All Grades`)

mobile <- mobile %>% select(!`District Name`)

teachProg <- teachProg %>% 
  mutate(`Gen Ed %` = `General Education (#)`/ `FTE Count`) %>% 
  select(`District Code`, `Gen Ed %`)

selectPop <- selectPop %>% select(!c(`District Name`, `Free Lunch #`, `Free Lunch %`, `Reduced Lunch #`, `Reduced Lunch %`, `Economically Disadvantaged #`, `Economically Disadvantaged %`, `English Language Learner %`, `Students With Disabilities %`))

```


## Joining Data

```{r}
eduData <- inner_join(sat, expend, by = "District Code") %>% 
  inner_join(salary, by = "District Code") %>% 
  inner_join(enroll, by = "District Code") %>% 
  inner_join(ap, by = "District Code") %>% 
  inner_join(reten, by = "District Code") %>% 
  inner_join(classSize, by = "District Code") %>% 
  inner_join(college, by = "District Code") %>% 
  inner_join(attendance, by = "District Code") %>%
  inner_join(attrition, by = "District Code") %>%
  inner_join(advCourse, by = "District Code") %>% 
  inner_join(gradRate, by = "District Code") %>% 
  inner_join(art, by = "District Code") %>% 
  inner_join(eduAge, by = "District Code") %>% 
  inner_join(discipline, by = "District Code") %>%
  inner_join(eduGen, by = "District Code") %>%
  inner_join(teachData, by = "District Code") %>%
  inner_join(teachProg, by = "District Code") %>%
  inner_join(selectPop, by = "District Code") %>%
  mutate(`Percent of HS in AP` = `Tests Takers` / `HS Enrollment` * 100) %>% 
  mutate(`Adjusted Score` = `Total Score` * `% Graduated` / 100)

eduData$`District Code` <- as.double(eduData$`District Code`)

eduData <- eduData %>% 
  inner_join(pop, by = "District Code") %>%
  inner_join(eth, by = "District Code") %>%
  inner_join(dropout, by = "District Code") %>%
  inner_join(mobile, by = "District Code")
```

## Aditional EDA

```{r}
summary(eduData)
```

**Inference from summary: **
1) Neither Reading/Writing, nor Math has a perfect score in SAT, same goes for the total score.

2) Among races, at least one district had Hispanic and White students in domination,even though the third quartile of Hispanic students is at 14.05%.

3) At least one district/school has 100% graduate rate and 0% drop rate and yet maximum percentage of students going to College is only 88.30.

4) At least one district/school has % Students Completing Advanced as 100% and none has 100% attendance rate.

5) One school district has 71.80% of their teachers with no license or only a provisional license.

6) None of the school/district has **only** experienced teachers, and in at least one school, 42.4% teachers are not experienced.

7) The data is taken for the COVID time-period(2020-22), yet at least one school had Percent Teaching In-Field as 100%.

8) Even though the schools are in a country where English is the most-commonly spoken language, at least one school has 83.600% students whose first Language is not English.

9) None of the schools has 0% of High Needs or Economically Disadvantaged students.

### To see if genders had a relation with Total SAT score.
```{r echo=FALSE}
eduData %>% ggplot( mapping=aes(x=`% Female Teachers`,y=`Total Score`))+
  geom_point() +
  geom_smooth(method=lm) +
  labs(title="Positive Relationship: Female% vs SAT",
       x="Female % ", y="SAT Score") +
  theme_minimal()

```
### Average Class Size vs SAT, Graduate Rate, and Enrollment in college

```{r echo=FALSE}
g1 <- eduData %>% ggplot(aes(x=`Average Class Size`, y=`Total Score`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g2 <- eduData %>% ggplot( mapping=aes(x=`Average Class Size`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g3 <- eduData %>% ggplot( mapping=aes(x=`Average Class Size`,y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

gridExtra::grid.arrange(
  g1, g2,g3,
  top = textGrob("Relationship of responses with Average Class Size",
                                   gp=gpar(fontsize=15,font=3)))

```
Average Class Size has negative relationship with SAT score and % graduated, while it has a positive relationship with % going to college.

```{r echo=FALSE}

g1 <- eduData %>% ggplot( mapping=aes(x=`% Students Completing Advanced`,
                                      y=`Total Score`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g2 <- eduData %>% ggplot( mapping=aes(x=`% Students Completing Advanced`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()


g3 <- eduData %>% ggplot( mapping=aes(x=`% Students Completing Advanced`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

gridExtra::grid.arrange(
  g1, g2,g3,
  top = textGrob("Relationship of responses with % Students Completing Advanced",
                                   gp=gpar(fontsize=15,font=3)))


```
All responses had positive relationship with % Students Completing Advanced.

### Attendance Rate vs Responses
```{r echo=FALSE}
g1 <- eduData %>% ggplot( mapping=aes(x=`Attendance Rate`,
                                      y=`Total Score`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g2 <- eduData %>% ggplot( mapping=aes(x=`Attendance Rate`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g3 <- eduData %>% ggplot( mapping=aes(x=`Attendance Rate`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

gridExtra::grid.arrange(
  g1,g2,g3,
  top = textGrob("Relationship of responses with Attendance Rate",
                                   gp=gpar(fontsize=15,font=3)))


```

```{r echo=FALSE}
g1 <- eduData %>% ggplot( mapping=aes(x=`Average # of Absences`,
                                      y=`Total Score`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g2 <- eduData %>% ggplot( mapping=aes(x=`Average # of Absences`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g3 <- eduData %>% ggplot( mapping=aes(x=`Average # of Absences`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

gridExtra::grid.arrange(
  g1,g2,g3,
  top = textGrob("Negative Relationship of responses with Average 
                 Number of Absences", gp=gpar(fontsize=15,font=3)))


```

```{r echo=FALSE}
g1 <- eduData %>% ggplot( mapping=aes(x=`Attrition`,
                                      y=`Total Score`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g2 <- eduData %>% ggplot( mapping=aes(x=`Attrition`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g3 <- eduData %>% ggplot( mapping=aes(x=`Attrition`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

gridExtra::grid.arrange(
  g1,g2,g3,
  top = textGrob("Negative Relationship of responses with Attrition", 
                 gp=gpar(fontsize=14,font=3)))
```
Even though, all of them has negative relationship, the slopes are different i.e., graduation rate drops with larger difference as compared to other responses.

### Student Background vs Graduation Rate, % Going to College
```{r echo=FALSE}
g1 <- eduData %>% ggplot( mapping=aes(x=`African American %`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()#-

g2 <- eduData %>% ggplot( mapping=aes(x=`Asian %`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g3 <- eduData %>% ggplot( mapping=aes(x=`Hispanic %`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()#-

g4 <- eduData %>% ggplot( mapping=aes(x=`White %`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g5 <- eduData %>% ggplot( mapping=aes(x=`Native American %`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g6 <- eduData %>% ggplot( mapping=aes(x=`Native Hawaiian, Pacific Islander %`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()#-

g7 <- eduData %>% ggplot( mapping=aes(x=`Multi-Race, Non-Hispanic %`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

gridExtra::grid.arrange(
  g1,g2,g3,g4,g5,g6,g7,
  top = textGrob("Relationship of Student Demographics with % Graduated", 
                 gp=gpar(fontsize=15,font=3)))
```


```{r echo=FALSE}
g1 <- eduData %>% ggplot( mapping=aes(x=`African American %`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point(alpha=0.1) +
  geom_smooth(method=lm) +
  labs(y="Going College(%)") +
  theme_minimal()

g2 <- eduData %>% ggplot( mapping=aes(x=`Asian %`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point(alpha=0.1) +
  geom_smooth(method=lm) +
  labs(y="Going College(%)") +
  theme_minimal()

g3 <- eduData %>% ggplot( mapping=aes(x=`Hispanic %`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point(alpha=0.1) +
  geom_smooth(method=lm) +
  labs(y="Going College(%)") +
  theme_minimal()#-

g4 <- eduData %>% ggplot( mapping=aes(x=`White %`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point(alpha=0.1) +
  geom_smooth(method=lm) +
  labs(y="Going College(%)") +
  theme_minimal()

g5 <- eduData %>% ggplot( mapping=aes(x=`Native American %`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point(alpha=0.1) +
  geom_smooth(method=lm) +
  labs(y="Going College(%)") +
  theme_minimal()#-

g6 <- eduData %>% ggplot( mapping=aes(x=`Native Hawaiian, Pacific Islander %`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point(alpha=0.1) +
  geom_smooth(method=lm) +
  labs(y="Going College(%)") +
  theme_minimal()

g7 <- eduData %>% ggplot( mapping=aes(x=`Multi-Race, Non-Hispanic %`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point(alpha=0.1) +
  geom_smooth(method=lm) +
  labs(y="Going College(%)") +
  theme_minimal()

gridExtra::grid.arrange(
  g1,g2,g3,g4,g5,g6,g7,
  top = textGrob("Relationship with Percent Going to College", 
                 gp=gpar(fontsize=15,font=3)))
```


### % of Teachers <40 and responses
```{r echo=FALSE}

g1 <- eduData %>% ggplot( mapping=aes(x=`% of Teachers <40`,
                                      y=`Total Score`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g2 <- eduData %>% ggplot( mapping=aes(x=`% of Teachers <40`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g3 <- eduData %>% ggplot( mapping=aes(x=`% of Teachers <40`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

gridExtra::grid.arrange(
  g1,g2,g3,
  top = textGrob("Relationship of responses with Teacher's Age", 
                 gp=gpar(fontsize=15,font=3)))

```
Schools with more % of teacher's age less than 40, had a negative affect on Total SAT score and graduation rate.

```{r echo=FALSE}

g1 <- eduData %>% ggplot( mapping=aes(x=`% in an Art Course`,
                                      y=`Total Score`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g2 <- eduData %>% ggplot( mapping=aes(x=`% in an Art Course`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g3 <- eduData %>% ggplot( mapping=aes(x=`% in an Art Course`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

gridExtra::grid.arrange(
  g1,g2,g3,
  top = textGrob("Relationship of responses with % in an Art Course", 
                 gp=gpar(fontsize=15,font=3)))

```

```{r echo=FALSE}

g1 <- eduData %>% ggplot( mapping=aes(x=`First Language Not English %`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g2 <- eduData %>% ggplot( mapping=aes(x=`English Language Learner %`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()

g3 <- eduData %>% ggplot( mapping=aes(x=`Students with Disabilities %`,
                                      y=`% Graduated`))+
  geom_point() +
  geom_smooth(method=lm) +
  theme_minimal()



gridExtra::grid.arrange(
  g1,g2,g3,
  top = textGrob("Negative Relationship of % Graduated with different classes%", 
                 gp=gpar(fontsize=15,font=3)))
```

### Percent Teaching In-Field vs 3 responses
```{r echo=FALSE}
# Percent Teaching In-Field
g1 <- eduData %>% ggplot( mapping=aes(x=`Percent Teaching In-Field`,
                                      y=`Total Score`))+
  geom_point(alpha=0.1) +
  geom_smooth(method=lm) +
  theme_minimal()

g2 <- eduData %>% ggplot( mapping=aes(x=`Percent Teaching In-Field`,
                                      y=`Attending Coll./Univ. (%)`))+
  geom_point(alpha=0.1) +
  geom_smooth(method=lm) +
  theme_minimal()

g3 <- eduData %>% ggplot( mapping=aes(x=`Percent Teaching In-Field`,
                                      y=`% Graduated`))+
  geom_point(alpha=0.1) +
  geom_smooth(method=lm) +
  theme_minimal()

gridExtra::grid.arrange(
  g1,g2,g3,
  top = textGrob("Relationship of responses with % Teaching In-Field", 
                 gp=gpar(fontsize=14,font=3)))
```






# Models

## Partitioning the data

```{r}
set.seed(2)

edu_part <- resample_partition(eduData,
                                    p=c(train=0.8,
                                        test=0.1,
                                        valid=0.1))
```


## Calculating correlations
```{r}
temp <- eduData %>% 
select(!c(`District Name`, `District Code`, `Reading / Writing`, `Math`, )) %>% na.omit

correlations <- data.frame(abs(cor(temp))) 

satCorr <- correlations %>% 
  select(Total.Score) %>% 
  filter(Total.Score > 0.5)

gradCorr <- correlations %>% 
  select(X..Graduated) %>% 
  filter(X..Graduated > 0.5)

collCorr <- correlations %>% 
  select(Attending.Coll..Univ.....) %>% 
  filter(Attending.Coll..Univ..... > 0.5)


```


## SAT 
### SAT eda feature selection
```{r}
rownames(satCorr)
```

```{r echo=FALSE}
g1 <- ggplot(eduData, aes(x=`Adv Course % Math`, y= `Total Score`))+
  geom_point()+
  geom_smooth()
g2 <- ggplot(eduData, aes(x=`Low Income %`, y= `Total Score`))+
  geom_point()+
  geom_smooth()
g3 <- ggplot(eduData, aes(x=`High Needs #...16`, y= `Total Score`))+
  labs(x="High Needs %")+
  geom_point()+
  geom_smooth()
g4 <- ggplot(eduData, aes(x=`Percent of HS in AP`, y= `Total Score`))+
  geom_point()+
  geom_smooth()
g5 <- ggplot(eduData, aes(x=`Economically Disadvantaged %`, y= `Total Score`))+
  geom_point()+
  geom_smooth()
g6 <- ggplot(eduData, aes(x=log1p(`Asian %`), y= `Total Score`))+
  geom_point()+
  geom_smooth()

gridExtra::grid.arrange(
  g1, g2,g3,g4, g5, g6,
  top = textGrob("High Correlation with SAT Score",
                                   gp=gpar(fontsize=15,font=3)))

```


```{r}
satEDA <- lm(`Total Score` ~ `Adv Course % Math`  + `Low Income %` + `High Needs #...16` + `Percent of HS in AP` + `Economically Disadvantaged %` + log1p(`Asian %`), data = edu_part$train)

summary(satEDA)

rmse(satEDA, edu_part$test)/1600

car::vif(satEDA)
```

```{r}
# cited this function from prof's 7-Modeling2.Rmd
step1 <- function(response, predictors, candidates, partition)
{
  rhs <- paste0(paste0(predictors, collapse="+"), "+", candidates)
  formulas <- lapply(paste0(response, "~", rhs), as.formula)
  rmses <- sapply(formulas,
                  function(fm) rmse(lm(fm, data=partition$train),
                                    data=partition$valid))
  names(rmses) <- candidates
  attr(rmses, "best") <- rmses[which.min(rmses)]
  rmses
}
```

```{r}
model <- NULL
preds <- "1"
cands <- c('`Adv Course % Math`' , '`Low Income %`', '`High Needs #...16`', '`Percent of HS in AP`', '`Economically Disadvantaged %`', 'log1p(`Asian %`)')
s1 <- step1("`Total Score`", preds, cands, edu_part)

model <- c(model, attr(s1, "best"))
s1
```

```{r}
preds <- "`Adv Course % Math`"
cands <- c('`Low Income %`', '`High Needs #...16`', '`Percent of HS in AP`', '`Economically Disadvantaged %`', 'log1p(`Asian %`)')
s2 <- step1("`Total Score`", preds, cands, edu_part)

model <- c(model, attr(s2, "best"))
s2
```

```{r}
preds <- c("`Adv Course % Math`", "`Percent of HS in AP`")
cands <- c('`Low Income %`', '`High Needs #...16`', '`Economically Disadvantaged %`', 'log1p(`Asian %`)')
s3 <- step1("`Total Score`", preds, cands, edu_part)

model <- c(model, attr(s3, "best"))
s3
```

```{r}
preds <- c("`Adv Course % Math`", "`Percent of HS in AP`", 'log1p(`Asian %`)')
cands <- c('`Low Income %`', '`High Needs #...16`', '`Economically Disadvantaged %`')
s4 <- step1("`Total Score`", preds, cands, edu_part)

model <- c(model, attr(s4, "best"))
s4
```

```{r}
preds <- c("`Adv Course % Math`", "`Percent of HS in AP`", 'log1p(`Asian %`)', '`Economically Disadvantaged %`')
cands <- c('`Low Income %`', '`High Needs #...16`')
s5 <- step1("`Total Score`", preds, cands, edu_part)

model <- c(model, attr(s5, "best"))
s5
```

```{r}
preds <- c("`Adv Course % Math`", "`Percent of HS in AP`", 'log1p(`Asian %`)', '`Economically Disadvantaged %`', '`High Needs #...16`')
cands <- c('`Low Income %`')
s6 <- step1("`Total Score`", preds, cands, edu_part)

model <- c(model, attr(s6, "best"))
s6
```

```{r echo=FALSE}
step_model <- tibble(index=seq_along(model),
                     variable=factor(names(model), levels=names(model)),
                     RMSE=model)

ggplot(step_model, aes(y=RMSE)) +
  geom_point(aes(x=variable)) +
  geom_line(aes(x=index)) +
  labs(title="Stepwise model selection with SAT score correlated features") +
  theme_minimal()+
  theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=1))
```

```{r}
satEDA <- lm(`Total Score` ~ `Adv Course % Math` + `Percent of HS in AP` + log1p(`Asian %`), data = edu_part$train)

summary(satEDA)

rmse(satEDA, edu_part$test)/1600

car::vif(satEDA)
```

### SAT Feature selection with all available

```{r}
temp <- eduData %>% 
  select(!c(`District Name`, `District Code`, `Tests Taken`, `Salary Totals`, `FTE Count`, `HS Enrollment`, Enrollment, `Tests Takers`, `Adjusted Score`, `% Graduated`, `Total # of Teachers (FTE)`, `Reading / Writing`, `Math`, `Attending Coll./Univ. (%)`, `Average # of Absences`))

base.mod <- lm(`Total Score` ~ 1 , data=temp) 
all.mod <- lm(`Total Score` ~ . , data= temp)
stepMod <- step(base.mod, scope = list(lower = base.mod, upper = all.mod), direction = "both", trace = 0, steps = 1000)

shortlistedVars <- names(unlist(stepMod[[1]])) 
shortlistedVars <- shortlistedVars[!shortlistedVars %in% "(Intercept)"]

print(shortlistedVars)

```

```{r}
summary(lm(`Total Score` ~ `Low Income %` + `Asian %` + `% Disciplined` + `Multi-Race, Non-Hispanic %` + `% Dropout All Grades` + `English Language Learner %` + `Teacher Retention Rate` + `% of Teachers <40` + `Percent of HS in AP` + `Percent of Experienced Teachers` + `% Female Teachers` + `Gen Ed %` + `African American %` + `% Intake`, data = eduData))
```

```{r}
totalScoreMod <- lm(`Total Score` ~ `Low Income %` + `Asian %` + `% Disciplined` + `Multi-Race, Non-Hispanic %`  + `Teacher Retention Rate`, data = edu_part$train)

summary(totalScoreMod)

rmse(totalScoreMod, edu_part$test)/1600

car::vif(totalScoreMod)
```

#### Diagnostics 

```{r}
g1 <- eduData %>%
  add_residuals(satEDA, "resid") %>%
  ggplot(aes(y=resid,x=`Adv Course % Math`)) +
  geom_point() +
  labs(y="Residuals") +
  theme_minimal()
g2 <- eduData %>%
  add_residuals(satEDA, "resid") %>%
  ggplot(aes(y=resid,x=`Percent of HS in AP` )) +
  geom_point() +
  labs(y="Residuals") +
  theme_minimal()
g3 <- eduData %>%
  add_residuals(satEDA, "resid") %>%
  ggplot(aes(y=resid,x=log1p(`Asian %`)  )) +
  geom_point() +
  labs(y="Residuals") +
  theme_minimal()

g4 <- eduData %>%
  add_residuals(satEDA, "resid") %>%
  ggplot(aes(sample=resid)) +
  geom_qq() +
  theme_minimal()+
  labs(title = "QQ Plot")
gridExtra::grid.arrange(
  g1, g2,g3,g4,
  top = textGrob("Residual Plots",
                                   gp=gpar(fontsize=15,font=3)))

g1 <- eduData %>%
  add_residuals(totalScoreMod, "resid") %>%
  ggplot(aes(y=resid,x=`Low Income %`)) +
  geom_point() +
  labs(y="Residuals") +
  theme_minimal()
g2 <- eduData %>%
  add_residuals(totalScoreMod, "resid") %>%
  ggplot(aes(y=resid,x=`Asian %` )) +
  geom_point() +
  labs(y="Residuals") +
  theme_minimal()
g3 <- eduData %>%
  add_residuals(totalScoreMod, "resid") %>%
  ggplot(aes(y=resid,x=`% Disciplined` )) +
  geom_point() +
  labs(y="Residuals") +
  theme_minimal()
g4 <- eduData %>%
  add_residuals(totalScoreMod, "resid") %>%
  ggplot(aes(y=resid,x=`Multi-Race, Non-Hispanic %` )) +
  geom_point() +
  labs(y="Residuals") +
  theme_minimal()
g5 <- eduData %>%
  add_residuals(totalScoreMod, "resid") %>%
  ggplot(aes(y=resid,x=`Teacher Retention Rate` )) +
  geom_point() +
  labs(y="Residuals") +
  theme_minimal()



g6 <- eduData %>%
  add_residuals(totalScoreMod, "resid") %>%
  ggplot(aes(sample=resid)) +
  geom_qq() +
  theme_minimal()+
  labs(title = "QQ Plot")

gridExtra::grid.arrange(
  g1, g2,g3,g4,g5,g6,
  top = textGrob("Residuals Plots",
                                   gp=gpar(fontsize=15,font=3)))


```


## Graduation rate 
### Graduation rate EDA model

```{r}
rownames(gradCorr)
```

```{r echo=FALSE}
g1 <- ggplot(eduData, aes(x=`Attendance Rate`, y= `% Graduated`))+
  geom_point()+
  geom_smooth()
g2 <- ggplot(eduData, aes(x=`Average # of Absences`, y= `% Graduated`))+
  geom_point()+
  geom_smooth()
g3 <- ggplot(eduData, aes(x=`Attrition`, y= `% Graduated`))+
  geom_point()+
  geom_smooth()
g4 <- ggplot(eduData, aes(x=log2(1+`First Language Not English %`), y= `% Graduated`))+
  geom_point()+
  geom_smooth()
g5 <- ggplot(eduData, aes(x=`Low Income %`, y= `% Graduated`))+
  geom_point()+
  geom_smooth()
g6 <- ggplot(eduData, aes(x=`High Needs #...16`, y= `% Graduated`))+
  geom_point()+
  geom_smooth()

gridExtra::grid.arrange(
  g1, g2,g3,g4, g5, g6,
  top = textGrob("High Correlation with Graduated Rate",
                                   gp=gpar(fontsize=15,font=3)))
```

```{r echo=FALSE}
g1 <- ggplot(eduData, aes(x=`% Stability`, y= `% Graduated`))+
  geom_point()+
  geom_smooth()
g2 <- ggplot(eduData, aes(x=log2(1+`Hispanic %`), y= `% Graduated`))+
  geom_point()+
  geom_smooth()
g3 <- ggplot(eduData, aes(x=`White %`, y= `% Graduated`))+
  geom_point()+
  geom_smooth()
g4 <- ggplot(eduData, aes(x=`% Dropout All Grades`, y= `% Graduated`))+
  geom_point()+
  geom_smooth()
g5 <- ggplot(eduData, aes(x=`% Churn`, y= `% Graduated`))+
  geom_point()+
  geom_smooth()
g6 <- ggplot(eduData, aes(x=`% Intake`, y= `% Graduated`))+
  geom_point()+
  geom_smooth()

gridExtra::grid.arrange(
  g1, g2,g3,g4, g5, g6,
  top = textGrob("High Correlation with Graduated Rate",
                                   gp=gpar(fontsize=15,font=3)))
```

```{r echo=FALSE}
g1 <- ggplot(eduData, aes(x=`Average Class Size`, y= `% Graduated`))+
  geom_point()+
  geom_smooth()
g2 <- ggplot(eduData, aes(x=log2(1+`African American %`), y= `% Graduated`))+
  geom_point()+
  geom_smooth()

gridExtra::grid.arrange(
  g1, g2,
  top = textGrob("High Correlation with Graduated Rate",
                                   gp=gpar(fontsize=15,font=3)))
```

```{r}
model <- NULL
preds <- "1"
cands <- c('`Attendance Rate`', '`Average # of Absences`', '`Attrition`',
                'log2(1+`First Language Not English %`)', '`Low Income %`',
                '`High Needs #...16`', '`% Stability`', 'log2(1+`Hispanic %`)',
                '`White %`', '`% Dropout All Grades`', '`% Churn`',
                '`% Intake`', 'log2(1+`African American %`)')
s1 <- step1("`% Graduated`", preds, cands, edu_part)

model <- c(model, attr(s1, "best"))
s1
```


```{r}
preds <- "`% Dropout All Grades`"
cands <- c('`Attendance Rate`', '`Average # of Absences`', '`Attrition`',
                'log2(1+`First Language Not English %`)', '`Low Income %`',
                '`High Needs #...16`', '`% Stability`', 'log2(1+`Hispanic %`)',
                '`White %`', '`% Churn`',
                '`% Intake`', 'log2(1+`African American %`)')
s2 <- step1("`% Graduated`", preds, cands, edu_part)

model <- c(model, attr(s2, "best"))
s2
```


```{r}
preds <- c("`% Dropout All Grades`", "`% Churn`")
cands <- c('`Attendance Rate`', '`Average # of Absences`', '`Attrition`',
                '`First Language Not English %`', '`Low Income %`',
                '`High Needs #...16`', '`% Stability`', 'log2(1+`Hispanic %`)',
                '`White %`', '`% Intake`', 'log2(1+`African American %`)')
s3 <- step1("`% Graduated`", preds, cands, edu_part)

model <- c(model, attr(s3, "best"))
s3
```

```{r}
preds <- c("`% Dropout All Grades`", "`% Churn`", '`Attrition`')
cands <- c('`Attendance Rate`', '`Average # of Absences`',
                '`First Language Not English %`', '`Low Income %`',
                '`High Needs #...16`', '`% Stability`', 'log2(1+`Hispanic %`)',
                '`White %`', '`% Intake`', 'log2(1+`African American %`)')
s4 <- step1("`% Graduated`", preds, cands, edu_part)

model <- c(model, attr(s4, "best"))
s4
```

```{r}
preds <- c("`% Dropout All Grades`", "`% Churn`", '`Attrition`', '`Attendance Rate`')
cands <- c('`Average # of Absences`',
                '`First Language Not English %`', '`Low Income %`',
                '`High Needs #...16`', '`% Stability`', 'log2(1+`Hispanic %`)',
                '`White %`', '`% Intake`', 'log2(1+`African American %`)')
s5 <- step1("`% Graduated`", preds, cands, edu_part)

model <- c(model, attr(s5, "best"))
s5
```

```{r}
preds <- c("`% Dropout All Grades`", "`% Churn`", '`Attrition`', '`Attendance Rate`', '`% Stability`' )
cands <- c('`Average # of Absences`',
                '`First Language Not English %`', '`Low Income %`',
                '`High Needs #...16`', 'log2(1+`Hispanic %`)',
                '`White %`', '`% Intake`', 'log2(1+`African American %`)')
s6 <- step1("`% Graduated`", preds, cands, edu_part)

model <- c(model, attr(s6, "best"))
s6
```

```{r echo=FALSE}
step_model <- tibble(index=seq_along(model),
                     variable=factor(names(model), levels=names(model)),
                     RMSE=model)

ggplot(step_model, aes(y=RMSE)) +
  geom_point(aes(x=variable)) +
  geom_line(aes(x=index)) +
  labs(title="Stepwise model selection with Grad Rate correlated features") +
  theme_minimal()
```

```{r}
grad_ead_model <- lm(`% Graduated` ~ `% Dropout All Grades` + `% Churn`, data=edu_part$train)
summary(grad_ead_model)
rmse(grad_ead_model, edu_part$test)
```

### Grad Rate Model with all available
```{r}
temp <- eduData %>% 
  select(!c(`District Name`, `District Code`, `Tests Taken`, `Salary Totals`, `FTE Count`, `HS Enrollment`, Enrollment, `Tests Takers`, `Adjusted Score`, `Total Score`, `Total # of Teachers (FTE)`, `Reading / Writing`, `Math`, `Attending Coll./Univ. (%)`, `Average # of Absences`))

base.mod <- lm(`% Graduated` ~ 1 , data=temp) 
all.mod <- lm(`% Graduated` ~ . , data= temp)
stepMod <- step(base.mod, scope = list(lower = base.mod, upper = all.mod), direction = "forward", trace = 0, steps = 1000)

shortlistedVars <- names(unlist(stepMod[[1]])) 
shortlistedVars <- shortlistedVars[!shortlistedVars %in% "(Intercept)"]

print(shortlistedVars)

```

```{r}
summary(lm(`% Graduated` ~ `% Dropout All Grades` + `% Intake` + `Economically Disadvantaged %` + Attrition + `Average Class Size` + `African American %` + `% Churn`, data = eduData))
```

```{r}
gradRateMod <- lm(`% Graduated` ~ `% Dropout All Grades` + `% Intake` + `Economically Disadvantaged %`, data = edu_part$train)

rmse(gradRateMod, edu_part$test)/100

summary(gradRateMod)

car::vif(gradRateMod)
```

```{r echo=FALSE}
eduData %>%
  add_residuals(grad_ead_model, "resid") %>%
  ggplot(aes(sample=resid)) +
  geom_qq() +
  theme_minimal()
```
```{r echo=FALSE}
eduData %>%
  add_residuals(grad_ead_model, "resid") %>%
  ggplot(aes(x=resid)) +
  geom_histogram(bins=100) +
  labs(x="Residuals") +
  theme_minimal()
```

```{r echo=FALSE}
eduData %>%
  add_residuals(gradRateMod, "resid") %>%
  ggplot(aes(sample=resid)) +
  geom_qq() +
  theme_minimal()
```

```{r echo=FALSE}
eduData %>%
  add_residuals(gradRateMod, "resid") %>%
  ggplot(aes(x=resid)) +
  geom_histogram(bins=100) +
  labs(x="Residuals") +
  theme_minimal()
```

## Percent going to college
### Percent going to college EDA model

```{r}

rownames(collCorr)

```

```{r echo=FALSE}

g1 <- ggplot(eduData, aes(x=`Total Score`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")
g2 <- ggplot(eduData, aes(x=`Attendance Rate`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")
g3 <- ggplot(eduData, aes(x=`Average # of Absences`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")
g4 <- ggplot(eduData, aes(x=`% Students Completing Advanced`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")
g5 <- ggplot(eduData, aes(x=`Adv Course % Math`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")
g6 <- ggplot(eduData, aes(x=`% in an Art Course`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")

gridExtra::grid.arrange(
  g1, g2,g3,g4, g5, g6,
  top = textGrob("High Correlation with Attending College / University",
                                   gp=gpar(fontsize=15,font=3)))
```

```{r echo=FALSE}
g1 <- ggplot(eduData, aes(x=`Percent of Teachers without Waiver or Provisional License`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")
g2 <- ggplot(eduData, aes(x=`Gen Ed %`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")
g3 <- ggplot(eduData, aes(x=`Low Income %`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")
g4 <- ggplot(eduData, aes(x=`High Needs #...16`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")
g5 <- ggplot(eduData, aes(x=`Percent of HS in AP`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")
g6 <- ggplot(eduData, aes(x=`Adjusted Score`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")

gridExtra::grid.arrange(
  g1, g2,g3,g4, g5, g6,
  top = textGrob("High Correlation with Attending College / University",
                                   gp=gpar(fontsize=15,font=3)))

```

```{r echo=FALSE}
g1 <- ggplot(eduData, aes(x=`Economically Disadvantaged %`, y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")
g2 <- ggplot(eduData, aes(x=log2(1 + `Hispanic %`), y= `Attending Coll./Univ. (%)`))+
  geom_point()+
  geom_smooth() + 
  labs(y="Attending College")

gridExtra::grid.arrange(
  g1, g2,
  top = textGrob("High Correlation with Attending College / University",
                                   gp=gpar(fontsize=15,font=3)))
```

```{r}

model <- NULL
preds <- "1"
cands <- c('`Total Score`'  , '`Attendance Rate`' , '`Average # of Absences`' ,
                '`% Students Completing Advanced`' , '`Adv Course % Math`' ,
                '`% in an Art Course`' , '`% in an Art Course`' , '`Percent of Teachers without Waiver or Provisional License`' ,
                '`Gen Ed %`' , '`Low Income %`' , '`High Needs #...16`' ,
                '`Percent of HS in AP`' , '`Adjusted Score`' , '`Economically Disadvantaged %`', 'log2(1 + `Hispanic %`)')
s1 <- step1("`Attending Coll./Univ. (%)`", preds, cands, edu_part)

model <- c(model, attr(s1, "best"))
s1

```

```{r}
preds <- "`Economically Disadvantaged %`"
cands <- c('`Total Score`'  , '`Attendance Rate`' , '`Average # of Absences`' ,
                '`% Students Completing Advanced`' , '`Adv Course % Math`' ,
                '`% in an Art Course`' , '`% in an Art Course`' , '`Percent of Teachers without Waiver or Provisional License`' ,
                '`Gen Ed %`' , '`Low Income %`' , '`High Needs #...16`' ,
                '`Percent of HS in AP`' , '`Adjusted Score`' , 'log2(1 + `Hispanic %`)')
s2 <- step1("`Attending Coll./Univ. (%)`", preds, cands, edu_part)

model <- c(model, attr(s2, "best"))
s2

```

```{r}
preds <- c("`Economically Disadvantaged %`", "`Percent of Teachers without Waiver or Provisional License`")
cands <- c('`Total Score`'  , '`Attendance Rate`' , '`Average # of Absences`' ,
                '`% Students Completing Advanced`' , '`Adv Course % Math`' ,
                '`% in an Art Course`' , '`% in an Art Course`' ,
                '`Gen Ed %`' , '`Low Income %`' , '`High Needs #...16`' ,
                '`Percent of HS in AP`' , '`Adjusted Score`' , 'log2(1 + `Hispanic %`)')
s3 <- step1("`Attending Coll./Univ. (%)`", preds, cands, edu_part)

model <- c(model, attr(s3, "best"))
s3

```

```{r}

preds <- c("`Economically Disadvantaged %`", "`Percent of Teachers without Waiver or Provisional License`", "`% in an Art Course`")
cands <- c('`Total Score`'  , '`Attendance Rate`' , '`Average # of Absences`' ,
                '`% Students Completing Advanced`' , '`Adv Course % Math`' ,
                '`Gen Ed %`' , '`Low Income %`' , '`High Needs #...16`' ,
                '`Percent of HS in AP`' , '`Adjusted Score`' , 'log2(1 + `Hispanic %`)')
s4 <- step1("`Attending Coll./Univ. (%)`", preds, cands, edu_part)

model <- c(model, attr(s4, "best"))
s4

```

```{r}

preds <- c("`Economically Disadvantaged %`", "`Percent of Teachers without Waiver or Provisional License`", "`% in an Art Course`", "`% Students Completing Advanced`")
cands <- c('`Total Score`'  , '`Attendance Rate`' , '`Average # of Absences`' ,
                '`Adv Course % Math`' ,
                '`Gen Ed %`' , '`Low Income %`' , '`High Needs #...16`' ,
                '`Percent of HS in AP`' , '`Adjusted Score`' , 'log2(1 + `Hispanic %`)')
s5 <- step1("`Attending Coll./Univ. (%)`", preds, cands, edu_part)

model <- c(model, attr(s5, "best"))
s5

```

```{r}
preds <- c("`Economically Disadvantaged %`", "`Percent of Teachers without Waiver or Provisional License`", "`% in an Art Course`", "`% Students Completing Advanced`", "`Gen Ed %`")
cands <- c('`Total Score`'  , '`Attendance Rate`' , '`Average # of Absences`' ,
                '`Adv Course % Math`' ,
                '`Low Income %`' , '`High Needs #...16`' ,
                '`Percent of HS in AP`' , '`Adjusted Score`' , 'log2(1 + `Hispanic %`)')
s6 <- step1("`Attending Coll./Univ. (%)`", preds, cands, edu_part)

model <- c(model, attr(s6, "best"))
s6

```

```{r}

preds <- c("`Economically Disadvantaged %`", "`Percent of Teachers without Waiver or Provisional License`", "`% in an Art Course`", "`% Students Completing Advanced`", "`Gen Ed %`", "`Adv Course % Math`")
cands <- c('`Total Score`'  , '`Attendance Rate`' , '`Average # of Absences`' ,
                '`Low Income %`' , '`High Needs #...16`' ,
                '`Percent of HS in AP`' , '`Adjusted Score`' , 'log2(1 + `Hispanic %`)')
s7 <- step1("`Attending Coll./Univ. (%)`", preds, cands, edu_part)

model <- c(model, attr(s7, "best"))
s7

```

```{r}

preds <- c("`Economically Disadvantaged %`", "`Percent of Teachers without Waiver or Provisional License`", "`% in an Art Course`", "`% Students Completing Advanced`", "`Gen Ed %`", "`Adv Course % Math`", "`Percent of HS in AP`")
cands <- c('`Total Score`'  , '`Attendance Rate`' , '`Average # of Absences`' ,
                '`Low Income %`' , '`High Needs #...16`' ,
                '`Adjusted Score`' , 'log2(1 + `Hispanic %`)')
s8 <- step1("`Attending Coll./Univ. (%)`", preds, cands, edu_part)

model <- c(model, attr(s8, "best"))
s8

```

```{r}

preds <- c("`Economically Disadvantaged %`", "`Percent of Teachers without Waiver or Provisional License`", "`% in an Art Course`", "`% Students Completing Advanced`", "`Gen Ed %`", "`Adv Course % Math`", "`Percent of HS in AP`", "log2(1 + `Hispanic %`)")
cands <- c('`Total Score`'  , '`Attendance Rate`' , '`Average # of Absences`' ,
                '`Low Income %`' , '`High Needs #...16`' ,
                '`Adjusted Score`' )
s9 <- step1("`Attending Coll./Univ. (%)`", preds, cands, edu_part)

model <- c(model, attr(s9, "best"))
s9

```

```{r}

preds <- c("`Economically Disadvantaged %`", "`Percent of Teachers without Waiver or Provisional License`", "`% in an Art Course`", "`% Students Completing Advanced`", "`Gen Ed %`", "`Adv Course % Math`", "`Percent of HS in AP`", "log2(1 + `Hispanic %`)", '`Attendance Rate`')
cands <- c('`Total Score`'  , '`Average # of Absences`' ,
                '`Low Income %`' , '`High Needs #...16`' ,
                '`Adjusted Score`' )
s10 <- step1("`Attending Coll./Univ. (%)`", preds, cands, edu_part)

model <- c(model, attr(s10, "best"))
s10

```

```{r}

preds <- c("`Economically Disadvantaged %`", "`Percent of Teachers without Waiver or Provisional License`", "`% in an Art Course`", "`% Students Completing Advanced`", "`Gen Ed %`", "`Adv Course % Math`", "`Percent of HS in AP`", "log2(1 + `Hispanic %`)", '`Attendance Rate`','`Average # of Absences`')
cands <- c('`Total Score`'  ,
                '`Low Income %`' , '`High Needs #...16`' ,
                '`Adjusted Score`' )
s11 <- step1("`Attending Coll./Univ. (%)`", preds, cands, edu_part)

model <- c(model, attr(s11, "best"))
s11

```

```{r echo=FALSE}

step_model <- tibble(index=seq_along(model),
                     variable=factor(names(model), levels=names(model)),
                     RMSE=model)

ggplot(step_model, aes(y=RMSE)) +
  geom_point(aes(x=variable)) +
  geom_line(aes(x=index)) +
  labs(title="Stepwise model selection") +
  theme_minimal()

```

```{r}

coll_ead_model <- lm(`Attending Coll./Univ. (%)` ~ `Economically Disadvantaged %`+ `Percent of Teachers without Waiver or Provisional License`+ `% in an Art Course`+ `Gen Ed %`+ `Adv Course % Math`+log2(1 + `Hispanic %`), data=edu_part$train)
summary(coll_ead_model)
rmse(coll_ead_model, edu_part$test)/100

```



### College % model using all features
```{r}
temp <- eduData %>% 
  select(!c(`District Name`, `District Code`, `Tests Taken`, `Salary Totals`, `FTE Count`, `HS Enrollment`, Enrollment, `Tests Takers`, `Adjusted Score`, `Total Score`, `Total # of Teachers (FTE)`, `Reading / Writing`, `Math`, `% Graduated`, `Average # of Absences`))

base.mod <- lm(`Attending Coll./Univ. (%)` ~ 1 , data=temp) 
all.mod <- lm(`Attending Coll./Univ. (%)` ~ . , data= temp)
stepMod <- step(base.mod, scope = list(lower = base.mod, upper = all.mod), direction = "both", trace = 0, steps = 1000)

shortlistedVars <- names(unlist(stepMod[[1]])) 
shortlistedVars <- shortlistedVars[!shortlistedVars %in% "(Intercept)"]

print(shortlistedVars)
```

```{r}
summary(lm(`Attending Coll./Univ. (%)` ~ `High Needs #...16` + `% Female Teachers` + `White %` + `Gen Ed %` + `Adv Course % Math` + `Economically Disadvantaged %` + `Total Expenditures per Pupil` + `Native American %` + `% of Teachers <40` + `Percent of Teachers without Waiver or Provisional License` + `First Language Not English %` + `English Language Learner %` + `Percent of HS in AP` + `% of Teachers Licensed` + `Native Hawaiian, Pacific Islander %` + `% Churn`, data = eduData))
```

```{r}
collegeMod <- lm(`Attending Coll./Univ. (%)` ~ `White %` + `Gen Ed %` + `Adv Course % Math` + `Economically Disadvantaged %` + `Total Expenditures per Pupil` + `Native American %` + `% of Teachers <40` + `Percent of Teachers without Waiver or Provisional License` + `First Language Not English %`, data = edu_part$train)

summary(collegeMod)

rmse(collegeMod, edu_part$test)/100

car::vif(collegeMod)

```

#### Diagnostics
```{r echo=FALSE}

eduData %>%
  add_residuals(coll_ead_model, "resid") %>%
  ggplot(aes(sample=resid)) +
  geom_qq() +
  theme_minimal()

```

```{r echo=FALSE}
eduData %>%
  add_residuals(coll_ead_model, "resid") %>%
  ggplot(aes(x=resid,y=`Attending Coll./Univ. (%)`)) +
  geom_point() +
  labs(x="Residuals") +
  theme_minimal()

```

```{r echo=FALSE}

eduData %>%
  add_residuals(collegeMod, "resid") %>%
  ggplot(aes(sample=resid)) +
  geom_qq() +
  theme_minimal()

```

```{r echo=FALSE}
eduData %>%
  add_residuals(collegeMod, "resid") %>%
  ggplot(aes(x=resid,y=`Attending Coll./Univ. (%)`)) +
  geom_point() +
  labs(x="Residuals") +
  theme_minimal()

```



# Comparing models

## SAT
EDA Features
```{r}
summary(satEDA)
rmse(satEDA, edu_part$valid)/1600
AIC(satEDA)
```


All available features
```{r}
summary(totalScoreMod)
rmse(totalScoreMod, edu_part$valid)/1600
AIC(totalScoreMod)
```




## Graduation Rate
EDA Features
```{r}
summary(grad_ead_model)
rmse(grad_ead_model, edu_part$valid)/100
AIC(grad_ead_model)
```

All available features
```{r}
rmse(gradRateMod, edu_part$valid)/100
summary(gradRateMod)
AIC(gradRateMod)
```



## College %
EDA features
```{r}
summary(coll_ead_model)
rmse(coll_ead_model, edu_part$valid)/100
AIC(coll_ead_model)
```


All available features
```{r}
summary(collegeMod)
rmse(collegeMod, edu_part$valid)/100
AIC(collegeMod)
```








